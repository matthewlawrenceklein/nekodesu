<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 py-12 px-4">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 mb-6">
      <div class="text-center mb-6">
        <span class="inline-block bg-blue-100 text-blue-800 text-sm font-semibold px-4 py-1 rounded-full">
          <%= @dialogue.difficulty_level.titleize %> (Levels <%= @dialogue.level_range %>)
        </span>
      </div>

      <%# Participants info %>
      <% if @dialogue.participants.present? %>
        <div class="text-center mb-6 text-sm text-gray-600 dark:text-gray-400">
          Conversation between <%= @dialogue.participants.join(" and ") %>
        </div>
      <% end %>

      <% if @dialogue.audio_files.present? %>
        <%# Play All Button %>
        <div class="text-center mb-6">
          <button id="playAllBtn" class="bg-purple-600 hover:bg-purple-700 dark:bg-purple-500 dark:hover:bg-purple-600 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 flex items-center gap-2 mx-auto">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
            </svg>
            <span>Play Entire Conversation</span>
          </button>
        </div>
        <%# Audio playback interface %>
        <div class="space-y-5 mb-8 max-h-[70vh] overflow-y-auto px-2">
          <% dialogue_lines = parse_dialogue_lines(@dialogue.japanese_text) %>
          <% first_speaker = dialogue_lines.first&.dig(:speaker) %>

          <% dialogue_lines.each_with_index do |line, index| %>
            <% if line[:speaker] %>
              <% audio_file = @dialogue.audio_files.find { |af| af["line_index"] == index } %>
              <div class="flex <%= message_alignment_class(line[:speaker], first_speaker) %> items-end gap-4">
                <% if line[:speaker] == first_speaker %>
                  <%# Left side - first speaker %>
                  <div class="flex-shrink-0">
                    <% if character_avatar_image(line[:speaker]) %>
                      <%= image_tag character_avatar_image(line[:speaker]), class: "w-16 h-16 rounded-full object-cover border-2 border-gray-200 dark:border-gray-600", alt: line[:speaker] %>
                    <% else %>
                      <div class="w-16 h-16 rounded-full <%= character_avatar_color(line[:speaker]) %> flex items-center justify-center text-white font-bold text-xl border-2 border-gray-200 dark:border-gray-600">
                        <%= line[:speaker].chars.first %>
                      </div>
                    <% end %>
                  </div>
                  <div class="flex flex-col items-start max-w-[70%]">
                    <span class="text-sm text-gray-500 dark:text-gray-400 mb-1 ml-2"><%= line[:speaker] %></span>
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-bl-sm px-5 py-4 w-full cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" onclick="toggleOverlay(this)">
                      <% if audio_file && audio_file["audio_key"] %>
                        <div class="flex items-center gap-3 mb-2">
                          <button class="audio-play-btn flex-shrink-0 w-10 h-10 rounded-full bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 flex items-center justify-center text-white transition-all shadow-md hover:shadow-lg" data-audio-url="<%= rails_blob_path(ActiveStorage::Blob.find_by(key: audio_file["audio_key"])) %>" data-line-index="<%= index %>">
                            <svg class="play-icon w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                              <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
                            </svg>
                            <svg class="pause-icon w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                              <path d="M5.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75A.75.75 0 007.25 3h-1.5zM12.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75h-1.5z"/>
                            </svg>
                          </button>
                          <span class="text-xs text-gray-500 dark:text-gray-400">Click bubble to reveal text</span>
                        </div>
                      <% else %>
                        <div class="text-sm text-gray-500 dark:text-gray-400 mb-2">
                          ðŸŽµ Audio generating...
                        </div>
                      <% end %>
                      <div class="text-container relative">
                        <p class="text-xl text-gray-900 dark:text-gray-100 font-japanese"><%= line[:text] %></p>
                        <div class="text-overlay absolute inset-0 bg-gray-100 dark:bg-gray-700 rounded transition-opacity duration-300"></div>
                      </div>
                    </div>
                  </div>
                <% else %>
                  <%# Right side - second speaker %>
                  <div class="flex flex-col items-end max-w-[70%]">
                    <span class="text-sm text-gray-500 dark:text-gray-400 mb-1 mr-2"><%= line[:speaker] %></span>
                    <div class="bg-blue-500 dark:bg-blue-600 rounded-2xl rounded-br-sm px-5 py-4 w-full cursor-pointer hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors" onclick="toggleOverlay(this)">
                      <% if audio_file && audio_file["audio_key"] %>
                        <div class="flex items-center gap-3 mb-2">
                          <button class="audio-play-btn flex-shrink-0 w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-white transition-all shadow-md hover:shadow-lg" data-audio-url="<%= rails_blob_path(ActiveStorage::Blob.find_by(key: audio_file["audio_key"])) %>" data-line-index="<%= index %>">
                            <svg class="play-icon w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                              <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
                            </svg>
                            <svg class="pause-icon w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                              <path d="M5.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75A.75.75 0 007.25 3h-1.5zM12.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75h-1.5z"/>
                            </svg>
                          </button>
                          <span class="text-xs text-white/75">Click bubble to reveal text</span>
                        </div>
                      <% else %>
                        <div class="text-sm text-white opacity-75 mb-2">
                          ðŸŽµ Audio generating...
                        </div>
                      <% end %>
                      <div class="text-container relative">
                        <p class="text-xl text-white font-japanese"><%= line[:text] %></p>
                        <div class="text-overlay absolute inset-0 bg-blue-500 dark:bg-blue-600 rounded transition-opacity duration-300"></div>
                      </div>
                    </div>
                  </div>
                  <div class="flex-shrink-0">
                    <% if character_avatar_image(line[:speaker]) %>
                      <%= image_tag character_avatar_image(line[:speaker]), class: "w-16 h-16 rounded-full object-cover border-2 border-gray-200 dark:border-gray-600", alt: line[:speaker] %>
                    <% else %>
                      <div class="w-16 h-16 rounded-full <%= character_avatar_color(line[:speaker]) %> flex items-center justify-center text-white font-bold text-xl border-2 border-gray-200 dark:border-gray-600">
                        <%= line[:speaker].chars.first %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>

        <%= button_to "Ready?", ready_dialogue_path(@dialogue), method: :post, class: "w-full bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white font-bold text-lg py-4 rounded-lg transition duration-200" %>
      <% else %>
        <%# No audio files yet %>
        <div class="text-center py-12">
          <div class="text-6xl mb-4">ðŸŽµ</div>
          <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">Audio is being generated</h3>
          <p class="text-gray-600 dark:text-gray-400 mb-6">
            Please wait a moment while we create the audio for this dialogue.
          </p>
          <%= link_to "Go Back", root_path, class: "inline-block bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200" %>
        </div>
      <% end %>
    </div>

    <div class="mt-6 text-center">
      <%= link_to "â† Back to Dashboard", root_path, class: "text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300" %>
    </div>
  </div>
</div>

<style>
  .font-japanese {
    font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ’ãƒ©ã‚®ãƒŽè§’ã‚´ Pro W3', 'Meiryo', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
    line-height: 2;
  }
  
  .text-container {
    position: relative;
  }
  
  .text-overlay {
    pointer-events: none;
    opacity: 1;
  }
  
  .text-overlay.hidden {
    opacity: 0;
  }
</style>

<script>
  let currentAudio = null;
  let currentButton = null;
  let isPlayingAll = false;
  let playAllQueue = [];
  let playAllIndex = 0;

  // Toggle overlay on individual message bubble
  function toggleOverlay(element) {
    const overlay = element.querySelector('.text-overlay');
    if (overlay) {
      overlay.classList.toggle('hidden');
    }
  }

  // Stop current audio if playing
  function stopCurrentAudio() {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
      if (currentButton) {
        const playIcon = currentButton.querySelector('.play-icon');
        const pauseIcon = currentButton.querySelector('.pause-icon');
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
      }
      currentAudio = null;
      currentButton = null;
    }
  }

  // Play audio for a specific button
  function playAudio(button, audioUrl) {
    // If clicking the same button that's playing, pause it
    if (currentButton === button && currentAudio && !currentAudio.paused) {
      stopCurrentAudio();
      return;
    }

    // Stop any currently playing audio
    stopCurrentAudio();

    // Create and play new audio
    currentAudio = new Audio(audioUrl);
    currentButton = button;

    const playIcon = button.querySelector('.play-icon');
    const pauseIcon = button.querySelector('.pause-icon');

    currentAudio.play();
    playIcon.classList.add('hidden');
    pauseIcon.classList.remove('hidden');

    // When audio ends, reset button
    currentAudio.addEventListener('ended', () => {
      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');

      // If playing all, advance to next
      if (isPlayingAll) {
        playAllIndex++;
        if (playAllIndex < playAllQueue.length) {
          setTimeout(() => {
            playAllQueue[playAllIndex].click();
          }, 500); // Small delay between tracks
        } else {
          // Finished playing all
          isPlayingAll = false;
          updatePlayAllButton();
        }
      }
    });
  }

  // Update Play All button text
  function updatePlayAllButton() {
    const playAllBtn = document.getElementById('playAllBtn');
    const btnText = playAllBtn.querySelector('span');
    if (isPlayingAll) {
      btnText.textContent = 'Stop Playing';
    } else {
      btnText.textContent = 'Play Entire Conversation';
    }
  }

  // Initialize audio controls
  document.addEventListener('DOMContentLoaded', () => {
    // Add click handlers to all audio play buttons
    const audioButtons = document.querySelectorAll('.audio-play-btn');
    audioButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent bubble click from triggering
        const audioUrl = button.dataset.audioUrl;
        playAudio(button, audioUrl);
      });
    });

    // Play All button handler
    const playAllBtn = document.getElementById('playAllBtn');
    if (playAllBtn) {
      playAllBtn.addEventListener('click', () => {
        if (isPlayingAll) {
          // Stop playing all
          isPlayingAll = false;
          stopCurrentAudio();
          updatePlayAllButton();
        } else {
          // Start playing all
          isPlayingAll = true;
          playAllQueue = Array.from(audioButtons);
          playAllIndex = 0;
          updatePlayAllButton();

          if (playAllQueue.length > 0) {
            playAllQueue[0].click();
          }
        }
      });
    }
  });
</script>
